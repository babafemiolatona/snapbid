<!doctype html>
<meta charset="utf-8">
<title>Multi WS STOMP Test</title>
<style>
body { font:14px system-ui, sans-serif; margin:1rem; }
fieldset { margin:.5rem 0; }
.conn { border:1px solid #888; padding:.5rem; margin:.75rem 0; }
pre { background:#111; color:#0f0; padding:.5rem; max-height:220px; overflow:auto; font-size:12px; }
label { margin-right:.75rem; display:inline-block; }
input.jwt { width:640px; }
</style>
<h1>Multi WS STOMP Test</h1>
<div>
  <label>Auction ID <input id="auctionId" value="35"></label>
  <label>WS URL <input id="wsUrl" value="ws://localhost:8080/ws" size="35"></label>
  <button id="addConn">Add Connection</button>
</div>
<div id="connections"></div>

<template id="tpl">
  <div class="conn">
    <fieldset>
      <legend>Connection</legend>
      <div>
        <label>JWT <input class="jwt" placeholder="Bearer ey..." /></label>
        <button class="connect">Connect</button>
        <button class="disconnect" disabled>Disconnect</button>
      </div>
      <div>
        <label><input type="checkbox" class="sub-bid" checked>bid</label>
        <label><input type="checkbox" class="sub-status">status</label>
        <label><input type="checkbox" class="sub-closed">closed</label>
        <label><input type="checkbox" class="sub-outbid" checked>outbid</label>
        <label><input type="checkbox" class="sub-meta" checked>meta</label>
      </div>
    </fieldset>
    <pre class="log"></pre>
  </div>
</template>

<script>
(function(){
  const connectionsDiv = document.getElementById('connections');
  document.getElementById('addConn').onclick = () => addConn();
  function addConn() {
    const node = document.getElementById('tpl').content.firstElementChild.cloneNode(true);
    const logEl = node.querySelector('.log');
    const auctionInput = document.getElementById('auctionId');
    const wsUrlInput = document.getElementById('wsUrl');
    const jwtInput = node.querySelector('.jwt');
    const btnConnect = node.querySelector('.connect');
    const btnDisconnect = node.querySelector('.disconnect');
    const ck = cls => node.querySelector('.' + cls);
    let ws, connected = false;
    const out = (...a) => { const s=a.join(' '); console.log(s); logEl.textContent += s + '\n'; logEl.scrollTop=logEl.scrollHeight; };
    out('INIT');
    btnConnect.onclick = () => {
      const jwt = jwtInput.value.trim();
      if (!jwt.startsWith('Bearer ')) { out('ERROR: JWT must start with "Bearer "'); return; }
      const auctionId = auctionInput.value.trim();
      const wsUrl = wsUrlInput.value.trim();
      out('Opening', wsUrl);
      ws = new WebSocket(wsUrl);
      ws.onopen = () => {
        out('OPEN send CONNECT');
        ws.send(
          'CONNECT\n' +
          'accept-version:1.2\n' +
          'host:localhost\n' +
          'authorization:' + jwt + '\n\n\0'
        );
      };
      ws.onmessage = e => {
        out('IN:', e.data.replace(/\0/g,'\\0'));
        if (!connected && e.data.startsWith('CONNECTED')) {
          connected = true;
            subscribe(auctionId);
            out('Subscribed auction', auctionId);
            btnConnect.disabled = true;
            btnDisconnect.disabled = false;
        }
      };
      ws.onclose = e => out('CLOSE', e.code, e.reason||'');
      ws.onerror = e => out('WS ERROR', e.message||e);
    };
    function subscribe(aid){
      if (ck('sub-bid').checked)
        ws.send('SUBSCRIBE\nid:bid-'+Date.now()+'\ndestination:/topic/auction/'+aid+'/bid\n\n\0');
      if (ck('sub-status').checked)
        ws.send('SUBSCRIBE\nid:status-'+Date.now()+'\ndestination:/topic/auction/'+aid+'/status\n\n\0');
      if (ck('sub-closed').checked)
        ws.send('SUBSCRIBE\nid:closed-'+Date.now()+'\ndestination:/topic/auction/'+aid+'/closed\n\n\0');
      if (ck('sub-outbid').checked)
        ws.send('SUBSCRIBE\nid:outbid-'+Date.now()+'\ndestination:/user/queue/outbid\n\n\0');
      if (ck('sub-meta').checked)
        ws.send('SUBSCRIBE\nid:meta-'+Date.now()+'\ndestination:/user/queue/notification-meta\n\n\0');
    }
    btnDisconnect.onclick = () => { if (ws && ws.readyState===WebSocket.OPEN) ws.close(); btnDisconnect.disabled = true; };
    connectionsDiv.appendChild(node);
  }
  addConn();
})();
</script>